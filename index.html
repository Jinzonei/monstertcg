<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monster TCG</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 { text-align: center; color: #444; }
        .section { margin-bottom: 20px; padding: 15px; background-color: #fafafa; border-radius: 6px; border: 1px solid #eee; }

        .resource-display {
            display: flex; justify-content: space-around; flex-wrap: wrap; text-align: center; font-size: 1.2em; font-weight: bold; margin-bottom: 20px;
        }
        .resource-item { display: flex; flex-direction: column; align-items: center; padding: 0 10px; }
        .resource-per-second { font-size: 0.8em; color: #777; }

        .button-group { text-align: center; margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .btn { padding: 10px 20px; font-size: 1em; cursor: pointer; border: none; border-radius: 5px; color: #fff; background-color: #007bff; transition: background-color 0.3s; }
        .btn:hover { background-color: #0056b3; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        #card-display { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        #deck-display { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; border: 2px dashed #999; padding: 10px; border-radius: 8px; min-height: 180px; align-items: center; }

        .card { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px; width: 150px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .card.selected { border: 2px solid #007bff; }
        .card.in-deck { border: 2px solid #28a745; }
        .card.Common { background-color: #b3e0ff; }
        .card.Uncommon { background-color: #c2f0c2; }
        .card.Rare { background-color: #ffccff; }
        .card.Epic { background-color: #ffb3b3; }
        .card.Legendary { background-color: #fffacd; }

        .card .hover-popup { display: none; position: absolute; top: 0; left: 100%; margin-left: 10px; padding: 10px; background-color: rgba(255,255,255,0.95); border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); font-size: 0.9em; width: 200px; z-index: 100; }
        .card:hover .hover-popup { display: block; }

        #battle-log { height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background-color: #f9f9f9; border-radius: 6px; }

        /* Generic popup (card details) */
        .card-popup { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; }
        .card-popup.open { display: block; }
        .popup-content { position: relative; background: #fff; margin: 40px auto; padding: 20px; max-width: 350px; border-radius: 8px; }
        .close-btn { position: absolute; top: 10px; right: 10px; font-size: 2em; background: none; border: none; cursor: pointer; }

        /* Battle overlay modal */
        #battle-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; }
        #battle-overlay.open { display: flex !important; justify-content: center; align-items: center; }
        .battle-overlay-content { background: #fff; border-radius: 12px; padding: 20px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative; }
        #battleCloseBtn { position: absolute; top: 10px; right: 10px; font-size: 28px; background: none; border: none; cursor: pointer; }
        #battle-simulation-log { height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; background: #fafafa; border-radius: 6px; }
        .battle-columns { display: flex; justify-content: space-around; text-align: center; gap: 20px; }
        .battle-cards { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }

        #pull-notification { position: fixed; top: 18px; left: 50%; transform: translateX(-50%); min-width: 180px; max-width: 80vw; padding: 12px 24px; border-radius: 24px; font-size: 1.2em; font-weight: bold; color: #222; z-index: 2000; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center; opacity: 0; pointer-events: none; transition: opacity 0.4s; }
        #pull-notification.show { opacity: 1; pointer-events: auto; }
        #pull-notification.Common { background: #b3e0ff; }
        #pull-notification.Uncommon { background: #c2f0c2; }
        #pull-notification.Rare { background: #ffccff; }
        #pull-notification.Epic { background: #ffb3b3; }
        #pull-notification.Legendary { background: #fffacd; }

        @media (max-width: 700px) {
            body { padding: 5px; }
            .container { max-width: 100vw; padding: 8px; border-radius: 0; box-shadow: none; }
            h1, h2 { font-size: 1.3em; }
            .section { padding: 6px; margin-bottom: 12px; }
            .resource-display { flex-direction: column; font-size: 1em; gap: 8px; }
            .button-group, .deck-controls, .upgrades-container { flex-direction: column !important; gap: 5px !important; }
            #deck-display, #card-display { flex-direction: row; flex-wrap: wrap; gap: 4px; padding: 4px; min-height: 100px; }
            .card, .battle-card { width: 95px !important; min-width: 85px; padding: 4px; font-size: 0.82em; }
            .card .hover-popup { left: auto; right: 0; top: 100%; width: 170px; margin-left: 0; margin-top: 6px; }
            #battle-log, .battle-log-overlay { font-size: 0.85em; height: 100px; }
            .card-popup { width: 100vw !important; right: 0 !important; left: 0 !important; top: 0 !important; border-radius: 0 !important; box-shadow: none !important; height: 100vh !important; max-width: none !important; }
            .popup-content { padding: 12px !important; }
            .close-btn { font-size: 32px !important; }
            .popup-buttons { flex-direction: column; gap: 7px; margin-top: 16px; }
        }
    </style>
</head>
<body>
    <div id="pull-notification" style="display:none;"></div>

    <div class="container">
        <h1>Monster TCG</h1>
        <p>Welcome to the Monster TCG! Collect cards, upgrade them, and battle to progress.</p>

        <div class="section resource-display">
            <div class="resource-item">Gold: <span id="gold">400</span>
                <div class="resource-per-second">+<span id="gold-gain">0</span>/s</div>
            </div>
            <div class="resource-item">Mana: <span id="mana">100</span>
                <div class="resource-per-second">+<span id="mana-gain">0</span>/s</div>
            </div>
            <div class="resource-item">Stage: <span id="stage">1</span></div>
        </div>

        <div class="section">
            <h2>Actions</h2>
            <div class="button-group">
                <button id="buyPackBtn" class="btn">Buy Card Pack (100 Gold)</button>
                <button id="startBattleBtn" class="btn" disabled>Start Battle</button>
            </div>
        </div>
        
        <div class="section upgrades-section">
            <h2>Upgrades</h2>
            <div class="upgrades-container">
                <button id="upgradePack5xBtn" class="btn" data-cost="5000" disabled>5x Pack Open (5000 Gold)</button>
                <button id="upgradePack10xBtn" class="btn" data-cost="20000" disabled>10x Pack Open (20000 Gold)</button>
                <button id="upgradeAutoBattleBtn" class="btn" data-cost="10000" disabled>Auto-Battle (10000 Gold)</button>
            </div>
        </div>

        <div class="section">
            <h2>Your Deck (<span id="deck-count">0</span>/4)</h2>
            <div id="deck-display">
                <p>Drag or add cards here to form your battle deck!</p>
            </div>
        </div>

        <div class="section">
            <h2>Your Cards</h2>
            <div id="sort-controls">
                Sort by:
                <button class="btn sort-btn" data-sort="level">Level</button>
                <button class="btn sort-btn" data-sort="rarity">Rarity</button>
                <button class="btn sort-btn" data-sort="idleGold">Idle Gold</button>
                <button class="btn sort-btn" data-sort="idleMana">Idle Mana</button>
                <button class="btn sort-btn" data-sort="allStatsBoost">All Stats</button>
            </div>
            <div id="card-display">
                <p>Buy a card pack to get your first card!</p>
            </div>
        </div>

        <div class="section">
            <h2>Battle Log</h2>
            <div id="battle-log"></div>
        </div>

        <div class="section">
            <h2>Current Bonuses</h2>
            <div id="bonus-stats"></div>
        </div>
    </div>

    <!-- Card Details Popup -->
    <div id="card-popup" class="card-popup">
        <div class="popup-content">
            <button class="close-btn" aria-label="Close">&times;</button>
            <h2 id="popup-card-name"></h2>
            <p><strong>Rarity:</strong> <span id="popup-card-rarity"></span></p>
            <p><strong>Level:</strong> <span id="popup-card-level"></span></p>
            <p><strong>XP:</strong> <span id="popup-card-xp"></span></p>
            <p><strong>Attack:</strong> <span id="popup-card-attack"></span></p>
            <p><strong>Defense:</strong> <span id="popup-card-defense"></span></p>
            <p id="popup-ability-row"><strong>Ability:</strong> <span id="popup-card-ability"></span></p>
            <div class="popup-buttons">
                <button id="upgradeCardBtn" class="btn">Upgrade Selected Card</button>
                <button id="addToDeckBtn" class="btn">Add to Deck</button>
                <button id="removeFromDeckBtn" class="btn">Remove from Deck</button>
            </div>
        </div>
    </div>

    <!-- Battle Overlay Modal -->
    <div id="battle-overlay">
        <div class="battle-overlay-content">
            <button id="battleCloseBtn" class="close-btn" aria-label="Close">&times;</button>
            <h2 style="text-align: center;">Battle</h2>
            <div id="battle-simulation-log"></div>
            <div class="battle-columns">
                <div>
                    <h3>Your Deck</h3>
                    <div id="player-battle-cards" class="battle-cards"></div>
                </div>
                <div>
                    <h3>Enemy Deck</h3>
                    <div id="enemy-battle-cards" class="battle-cards"></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="collectRewardsBtn" class="btn" style="display: none;">Collect Rewards</button>
            </div>
        </div>
    </div>

    <script>
    // --- GAME DATA ---
    const DECK_SIZE = 4;
    const rarityOrder = { "Common": 1, "Uncommon": 2, "Rare": 3, "Epic": 4, "Legendary": 5 };
    const allAbilities = {
        idleGold: { name: "Idle Gold Gain", unit: "/s", isPercentage: false, icon: "üí∞", type: "idle" },
        idleMana: { name: "Idle Mana Gain", unit: "/s", isPercentage: false, icon: "‚ú®", type: "idle" },
        rarityLuck: { name: "Rarity Luck", unit: "%", isPercentage: true, icon: "üçÄ", type: "active" },
        extraDraw: { name: "Extra Draw Chance", unit: "%", isPercentage: true, icon: "üÉè", type: "active" },
        freeDrawChance: { name: "Free Pack Chance", unit: "%", isPercentage: true, icon: "üéÅ", type: "active" },
        battleGold: { name: "Battle Gold Bonus", unit: "%", isPercentage: true, icon: "‚öú", type: "active" },
        battleMana: { name: "Battle Mana Bonus", unit: "%", isPercentage: true, icon: "üí†", type: "active" },
        battleXP: { name: "Battle XP Bonus", unit: "%", isPercentage: true, icon: "‚ú®", type: "active" },
        battleRewardsBoost: { name: "All Battle Rewards Boost", unit: "%", isPercentage: true, icon: "üèÜ", type: "active" },
        manaCostReduction: { name: "Mana Cost Reduction", unit: "%", isPercentage: true, icon: "üìâ", type: "idle" },
        allStatsBoost: { name: "All Cards Stat Boost", unit: "%", isPercentage: true, icon: "üìà", type: "idle" },
    };
    const fullCardPool = [
        // Common
        { id: "goblinGrunt", name: "Goblin Grunt", rarity: "Common", baseAttack: 5, baseDefense: 10, ability: { type: "idleGold", value: 0.5, description: "Adds {val} to idle gold per second." } },
        { id: "forestImp", name: "Forest Imp", rarity: "Common", baseAttack: 3, baseDefense: 7, ability: { type: "extraDraw", value: 0.02, description: "{val}% chance to pull an extra card from pack." } },
        { id: "ogreWarrior", name: "Ogre Warrior", rarity: "Common", baseAttack: 15, baseDefense: 25, ability: { type: "battleGold", value: 0.05, description: "Increases battle gold rewards by {val}%." } },
        { id: "mudMonster", name: "Mud Monster", rarity: "Common", baseAttack: 8, baseDefense: 18, ability: { type: "battleMana", value: 0.05, description: "Increases battle mana rewards by {val}%." } },
        { id: "ironGolem", name: "Iron Golem", rarity: "Common", baseAttack: 12, baseDefense: 22, ability: { type: "battleXP", value: 0.05, description: "Increases battle XP gain by {val}%." } },
        { id: "shadowAssassin", name: "Shadow Assassin", rarity: "Common", baseAttack: 10, baseDefense: 5, ability: { type: "rarityLuck", value: 0.01, description: "Increases chance of pulling rare cards by {val}%." } },
        { id: "fireElemental", name: "Fire Elemental", rarity: "Common", baseAttack: 7, baseDefense: 8, ability: { type: "freeDrawChance", value: 0.01, description: "{val}% chance for a free pack draw." } },
        { id: "iceGiant", name: "Ice Giant", rarity: "Common", baseAttack: 20, baseDefense: 15, ability: { type: "allStatsBoost", value: 0.02, description: "Increases all card stats by {val}%." } },
        { id: "earthElemental", name: "Earth Elemental", rarity: "Common", baseAttack: 10, baseDefense: 20, ability: { type: "manaCostReduction", value: 0.02, description: "Reduces mana cost of upgrades by {val}%." } },
        { id: "windElemental", name: "Wind Elemental", rarity: "Common", baseAttack: 5, baseDefense: 10, ability: { type: "idleGold", value: 0.2, description: "Adds {val} to idle gold per second." } },
        { id: "lightningSpirit", name: "Lightning Spirit", rarity: "Common", baseAttack: 6, baseDefense: 6, ability: { type: "idleMana", value: 0.2, description: "Adds {val} to idle mana per second." } },
        { id: "darkSorcerer", name: "Dark Sorcerer", rarity: "Common", baseAttack: 4, baseDefense: 12, ability: { type: "battleXP", value: 0.02, description: "Increases battle XP gain by {val}%." } },
        { id: "natureDruid", name: "Nature Druid", rarity: "Common", baseAttack: 3, baseDefense: 15, ability: { type: "battleRewardsBoost", value: 0.02, description: "Increases all battle rewards by {val}%." } },
        { id: "lightPaladin", name: "Light Paladin", rarity: "Common", baseAttack: 8, baseDefense: 20, ability: { type: "battleGold", value: 0.02, description: "Increases battle gold rewards by {val}%." } },
        { id: "shadowMage", name: "Shadow Mage", rarity: "Common", baseAttack: 5, baseDefense: 10, ability: { type: "battleMana", value: 0.02, description: "Increases battle mana rewards by {val}%." } },
        // Uncommon
        { id: "stoneGolem", name: "Stone Golem", rarity: "Uncommon", baseAttack: 10, baseDefense: 30, ability: { type: "battleRewardsBoost", value: 0.1, description: "Increases all battle rewards by {val}%." } },
        { id: "mushroomMage", name: "Mushroom Mage", rarity: "Uncommon", baseAttack: 15, baseDefense: 5, ability: { type: "idleGold", value: 1.0, description: "Adds {val} to idle gold per second." } },
        { id: "lavaCreature", name: "Lava Creature", rarity: "Uncommon", baseAttack: 20, baseDefense: 20, ability: { type: "battleGold", value: 0.1, description: "Increases battle gold rewards by {val}%." } },
        { id: "waterElemental", name: "Water Elemental", rarity: "Uncommon", baseAttack: 12, baseDefense: 15, ability: { type: "battleMana", value: 0.1, description: "Increases battle mana rewards by {val}%." } },
        { id: "windSpirit", name: "Wind Spirit", rarity: "Uncommon", baseAttack: 8, baseDefense: 10, ability: { type: "battleXP", value: 0.1, description: "Increases battle XP gain by {val}%." } },
        // Rare
        { id: "holyPaladin", name: "Holy Paladin", rarity: "Rare", baseAttack: 20, baseDefense: 25, ability: { type: "rarityLuck", value: 0.05, description: "Increases chance of pulling rare cards by {val}%." } },
        // Epic
        { id: "dragonKnight", name: "Dragon Knight", rarity: "Epic", baseAttack: 40, baseDefense: 40, ability: { type: "battleXP", value: 0.25, description: "Increases battle XP gain by {val}%." } },
        // Legendary
        { id: "phoenix", name: "Phoenix", rarity: "Legendary", baseAttack: 50, baseDefense: 50, ability: { type: "freeDrawChance", value: 0.02, description: "{val}% chance for a free pack draw." } }
    ];

    // --- GAME STATE ---
    const gameState = {
        gold: 400,
        mana: 100, // start at 100 to match UI
        stage: 1,
        cards: [],
        deck: [],
        selectedCardId: null,
        sortType: 'level',
        packMultiplier: 1,
        goldPerSecond: 5,
        manaPerSecond: 0,
    };

    // --- UTILS ---
    function getAbilityValue(type) {
        let value = 0;
        let cardsToCheck = type in allAbilities ? (allAbilities[type].type === "active" ? gameState.deck.map(id => findCardById(id)) : gameState.cards) : [];
        cardsToCheck.forEach(card => {
            if (card && card.ability && card.ability.type === type) {
                value += card.ability.value * card.level;
            }
        });
        return value;
    }
    function findCardById(id) { return gameState.cards.find(card => card.id === id); }

    // --- BATTLE UI HELPERS ---
    function openBattleOverlay() { battleOverlay.classList.add('open'); }
    function closeBattleOverlay() { battleOverlay.classList.remove('open'); }
    function battleLogOverlay(msg) { const entry = document.createElement('p'); entry.textContent = msg; battleSimulationLogEl.prepend(entry); }

    function createEnemyCard(stage) {
        const enemyId = 'enemy_' + Date.now() + '_' + Math.floor(Math.random()*10000);
        const baseAttack = 5 + stage * 2;
        const baseDefense = 5 + stage * 2;
        return { id: enemyId, name: `Enemy ${stage}`, attack: baseAttack, defense: baseDefense, rarity: 'Common' };
    }

    function displayBattleCards(cards, containerEl) {
        containerEl.innerHTML = '';
        cards.forEach(card => {
            const cardDiv = document.createElement('div');
            cardDiv.className = `battle-card ${card.rarity}`;
            cardDiv.style.width = '120px';
            cardDiv.innerHTML = `<h4>${card.name}</h4><p>‚öîÔ∏è ${card.attack} | üõ°Ô∏è ${card.defense}</p><p>‚ù§Ô∏è ${Math.max(0, card.health).toFixed(0)}</p>`;
            containerEl.appendChild(cardDiv);
        });
    }

    function addXP(card, amount) { if (!card) return; card.xp = (card.xp || 0) + amount; if (card.xp >= card.nextLevelXP) upgradeCard(card); }
    function addGold(amount) { gameState.gold += amount; log(`Gained ${amount} Gold.`); updateUI(); }
    function addMana(amount) { gameState.mana += amount; log(`Gained ${amount} Mana.`); updateUI(); }
    function log(msg) { const entry = document.createElement('p'); entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; document.getElementById('battle-log').prepend(entry); }

    // --- UI ELEMENTS ---
    const goldEl = document.getElementById('gold');
    const goldGainEl = document.getElementById('gold-gain');
    const manaEl = document.getElementById('mana');
    const manaGainEl = document.getElementById('mana-gain');
    const stageEl = document.getElementById('stage');
    const deckCountEl = document.getElementById('deck-count');
    const cardDisplay = document.getElementById('card-display');
    const deckDisplay = document.getElementById('deck-display');
    const buyPackBtn = document.getElementById('buyPackBtn');
    const startBattleBtn = document.getElementById('startBattleBtn');

    const collectRewardsBtn = document.getElementById('collectRewardsBtn');
    const battleOverlay = document.getElementById('battle-overlay');
    const battleCloseBtn = document.getElementById('battleCloseBtn');
    const battleSimulationLogEl = document.getElementById('battle-simulation-log');
    const playerBattleCardsEl = document.getElementById('player-battle-cards');
    const enemyBattleCardsEl = document.getElementById('enemy-battle-cards');

    const upgradeCardBtn = document.getElementById('upgradeCardBtn');
    const addToDeckBtn = document.getElementById('addToDeckBtn');
    const removeFromDeckBtn = document.getElementById('removeFromDeckBtn');
    const popup = document.getElementById('card-popup');
    const popupContent = popup.querySelector('.popup-content');
    const closeBtn = popup.querySelector('.close-btn');
    const sortBtns = document.querySelectorAll('.sort-btn');

    const pullNotification = document.getElementById('pull-notification');

    function showPullNotification(card) {
        pullNotification.textContent = card.name;
        pullNotification.className = `show ${card.rarity}`;
        pullNotification.style.display = 'block';
        setTimeout(() => { pullNotification.classList.remove('show'); setTimeout(() => { pullNotification.style.display = 'none'; }, 400); }, 2000);
    }

    // Buy pack
    buyPackBtn.addEventListener('click', function() {
        const packCost = 100;
        if (gameState.gold >= packCost) {
            gameState.gold -= packCost;
            const baseCard = fullCardPool[Math.floor(Math.random() * fullCardPool.length)];
            const existingCard = gameState.cards.find(c => c.id.startsWith(baseCard.id));
            if (existingCard) {
                existingCard.xp = (existingCard.xp || 0) + 10;
                while (existingCard.xp >= existingCard.nextLevelXP) upgradeCard(existingCard);
                showPullNotification({ name: `${existingCard.name} gains 10 XP!`, rarity: existingCard.rarity });
            } else {
                const newCard = { ...baseCard, id: baseCard.id + '_' + Date.now() + '_' + Math.floor(Math.random() * 10000), level: 1, xp: 0, nextLevelXP: 10, attack: baseCard.baseAttack, defense: baseCard.baseDefense };
                gameState.cards.push(newCard);
                showPullNotification(newCard);
            }
            updateUI();
        } else { alert("Not enough gold!"); }
    });

    // Gold/Mana tick
    setInterval(() => {
        const goldGain = 5 + getAbilityValue("idleGold");
        gameState.gold += goldGain;
        gameState.goldPerSecond = goldGain;
        gameState.mana += gameState.manaPerSecond || 0;
        updateUI();
    }, 1000);

    // Renderers
    function updateUI() {
        goldEl.textContent = gameState.gold.toFixed(1);
        manaEl.textContent = gameState.mana.toFixed(1);
        stageEl.textContent = gameState.stage;
        goldGainEl.textContent = (5 + getAbilityValue("idleGold")).toFixed(1);
        manaGainEl.textContent = (gameState.stage < 5 ? 0 : 5 + getAbilityValue("idleMana")).toFixed(1);
        deckCountEl.textContent = gameState.deck.length;
        displayCards();
        displayDeckCards();
        displayBonusStats();
        updateButtonStates();
        buyPackBtn.disabled = gameState.gold < 100;
    }
    function displayCards() {
        cardDisplay.innerHTML = '';
        const cardsNotInDeck = gameState.cards.filter(c => !gameState.deck.includes(c.id));
        if (cardsNotInDeck.length === 0) { cardDisplay.innerHTML = "<p>Your cards are either in your deck or you haven't bought any yet.</p>"; return; }
        let sortedCards = [...cardsNotInDeck];
        if (gameState.sortType === 'level') sortedCards.sort((a,b)=> b.level - a.level || b.xp - a.xp);
        else if (gameState.sortType === 'rarity') sortedCards.sort((a,b)=> rarityOrder[b.rarity] - rarityOrder[a.rarity]);
        else if (allAbilities[gameState.sortType]) sortedCards.sort((a,b)=>{ const valA = (a.ability && a.ability.type === gameState.sortType) ? a.ability.value * a.level : 0; const valB = (b.ability && b.ability.type === gameState.sortType) ? b.ability.value * b.level : 0; return valB - valA || b.level - a.level; });
        sortedCards.forEach(card => { const cardDiv = createCardElement(card); cardDiv.classList.add('not-in-deck'); cardDisplay.appendChild(cardDiv); });
    }
    function displayDeckCards() {
        deckDisplay.innerHTML = '';
        const deckCards = gameState.deck.map(id => findCardById(id));
        if (deckCards.length === 0) deckDisplay.innerHTML = '<p>Drag or add cards here to form your battle deck!</p>';
        deckCards.forEach(card => { const cardDiv = createCardElement(card); cardDiv.classList.add('in-deck'); deckDisplay.appendChild(cardDiv); });
    }
    function createCardElement(card) {
        const cardDiv = document.createElement('div');
        cardDiv.className = `card ${card.rarity}`;
        cardDiv.setAttribute('data-card-id', card.id);
        cardDiv.addEventListener('click', () => { gameState.selectedCardId = card.id; showCardDetails(card); });
        let abilityIcon = ''; let hoverPopupHtml = '';
        if (card.ability && allAbilities[card.ability.type]) {
            const abilityInfo = allAbilities[card.ability.type];
            abilityIcon = abilityInfo.icon;
            const formattedVal = (card.ability.value * (abilityInfo.isPercentage ? 100 : 1)).toFixed(2);
            const abilityText = card.ability.description.replace('{val}', formattedVal);
            hoverPopupHtml = `<div class="hover-popup"><h5>${abilityInfo.icon} ${abilityInfo.name}</h5><p>${abilityText}</p></div>`;
        }
        if (gameState.selectedCardId === card.id) cardDiv.classList.add('selected');
        cardDiv.innerHTML = `<h4>${card.name}</h4><p>${abilityIcon} Lvl: ${card.level}</p><p>‚öîÔ∏è ${card.attack} | üõ°Ô∏è ${card.defense}</p>${hoverPopupHtml}`;
        return cardDiv;
    }
    function displayBonusStats() {
        const bonusStatsEl = document.getElementById('bonus-stats');
        bonusStatsEl.innerHTML = '';
        for (const type in allAbilities) {
            const abilityInfo = allAbilities[type];
            let value = getAbilityValue(type);
            if (value === 0) continue;
            let displayVal = abilityInfo.isPercentage ? (value * 100).toFixed(2) + abilityInfo.unit : value.toFixed(2) + abilityInfo.unit;
            bonusStatsEl.innerHTML += `<div class="bonus-stat-item"><h4>${abilityInfo.icon} ${abilityInfo.name}</h4><p>${displayVal}</p></div>`;
        }
    }
    function updateButtonStates() { buyPackBtn.disabled = gameState.gold < 100; startBattleBtn.disabled = gameState.deck.length < DECK_SIZE; }

    // Popup logic
    function showCardDetails(card) {
        if (!card) return;
        gameState.selectedCardId = card.id;
        document.getElementById('popup-card-name').textContent = card.name;
        document.getElementById('popup-card-rarity').textContent = card.rarity;
        document.getElementById('popup-card-level').textContent = card.level;
        document.getElementById('popup-card-xp').textContent = `${card.xp || 0}/${card.nextLevelXP || 10}`;
        document.getElementById('popup-card-attack').textContent = card.attack;
        document.getElementById('popup-card-defense').textContent = card.defense;
        const abilityLabel = document.getElementById('popup-ability-row').querySelector('strong');
        const abilityText = document.getElementById('popup-card-ability');
        if (card.ability) {
            const abilityInfo = allAbilities[card.ability.type];
            const formattedVal = (card.ability.value * (abilityInfo.isPercentage ? 100 : 1)).toFixed(2);
            abilityText.textContent = card.ability.description.replace('{val}', formattedVal);
            abilityLabel.textContent = `${abilityInfo.type === 'idle' ? 'Idle Ability' : 'Active Ability'}:`;
        } else { abilityText.textContent = 'None'; abilityLabel.textContent = 'Ability:'; }
        if (gameState.deck.includes(card.id)) { addToDeckBtn.style.display = 'none'; removeFromDeckBtn.style.display = 'inline-block'; }
        else if (gameState.deck.length < DECK_SIZE) { addToDeckBtn.style.display = 'inline-block'; removeFromDeckBtn.style.display = 'none'; }
        else { addToDeckBtn.style.display = 'none'; removeFromDeckBtn.style.display = 'none'; }
        popup.classList.add('open'); popup.style.display = 'block';
        upgradeCardBtn.disabled = (card.xp || 0) < (card.nextLevelXP || 10);
        const newCloseBtn = popupContent.querySelector('.close-btn');
        newCloseBtn.addEventListener('click', closePopup);
        newCloseBtn.addEventListener('touchstart', closePopup);
    }
    function closePopup() { popup.classList.remove('open'); popup.style.display = 'none'; }
    closeBtn.addEventListener('click', closePopup);
    closeBtn.addEventListener('touchstart', closePopup);

    addToDeckBtn.addEventListener('click', function() { const cardId = gameState.selectedCardId; if (!cardId) return; if (gameState.deck.length < DECK_SIZE && !gameState.deck.includes(cardId)) { gameState.deck.push(cardId); updateUI(); closePopup(); } });
    removeFromDeckBtn.addEventListener('click', function() { const cardId = gameState.selectedCardId; if (!cardId) return; const idx = gameState.deck.indexOf(cardId); if (idx !== -1) { gameState.deck.splice(idx, 1); updateUI(); closePopup(); } });

    function upgradeCard(card) {
        if (!card) return;
        if ((card.xp || 0) >= (card.nextLevelXP || 10)) {
            card.level = (card.level || 1) + 1;
            card.xp = (card.xp || 0) - (card.nextLevelXP || 10);
            card.nextLevelXP = Math.floor((card.nextLevelXP || 10) * 1.5);
            card.attack = Math.floor((card.attack || card.baseAttack) * 1.15);
            card.defense = Math.floor((card.defense || card.baseDefense) * 1.15);
            if (card.ability && typeof card.ability.value === 'number') card.ability.value = parseFloat((card.ability.value * 1.15).toFixed(2));
            showPullNotification({ name: `${card.name} leveled up!`, rarity: card.rarity });
            updateUI();
        }
    }

    // Battle logic
    startBattleBtn.addEventListener('click', performBattle);
    function performBattle() { if (gameState.deck.length < DECK_SIZE) { log(`You need ${DECK_SIZE} cards in your deck to battle!`); return; } runBattleSimulation(); }

    function runBattleSimulation() {
        battleSimulationLogEl.innerHTML = '';
        openBattleOverlay();
        const playerDeck = gameState.deck.map(id => { const card = findCardById(id); return { ...card, health: card.attack + card.defense }; });
        const enemyCards = []; for (let i = 0; i < DECK_SIZE; i++) { const enemy = createEnemyCard(gameState.stage); enemy.health = enemy.attack + enemy.defense; enemyCards.push(enemy); }
        gameState.enemyCards = enemyCards;
        let playerTurn = true; let playerIndex = 0; let enemyIndex = 0;
        const turnInterval = setInterval(() => {
            displayBattleCards(playerDeck, playerBattleCardsEl);
            displayBattleCards(enemyCards, enemyBattleCardsEl);
            if (playerDeck.length === 0 || enemyCards.length === 0) { clearInterval(turnInterval); endBattle(playerDeck, enemyCards); return; }
            if (playerTurn) {
                const attacker = playerDeck[playerIndex]; const defender = enemyCards[enemyIndex];
                const damage = Math.max(0, attacker.attack - defender.defense);
                defender.health -= damage; battleLogOverlay(`${attacker.name} attacks ${defender.name} for ${damage} damage!`);
                if (defender.health <= 0) { battleLogOverlay(`${defender.name} was defeated!`); enemyCards.splice(enemyIndex, 1); if (enemyIndex >= enemyCards.length) enemyIndex = 0; }
                else { enemyIndex++; if (enemyIndex >= enemyCards.length) enemyIndex = 0; }
            } else {
                const attacker = enemyCards[enemyIndex]; const defender = playerDeck[playerIndex];
                const damage = Math.max(0, attacker.attack - defender.defense);
                defender.health -= damage; battleLogOverlay(`${attacker.name} attacks ${defender.name} for ${damage} damage!`);
                if (defender.health <= 0) { battleLogOverlay(`${defender.name} was defeated!`); playerDeck.splice(playerIndex, 1); if (playerIndex >= playerDeck.length) playerIndex = 0; }
                else { playerIndex++; if (playerIndex >= playerDeck.length) playerIndex = 0; }
            }
            playerTurn = !playerTurn;
        }, 500);
    }

    function endBattle(playerDeck, enemyCards) {
        const isWin = playerDeck.length > 0;
        const rewardsBoost = 1 + getAbilityValue("battleRewardsBoost");
        const goldBoost = getAbilityValue("battleGold");
        const manaBoost = getAbilityValue("battleMana");
        const xpBoost = 1 + getAbilityValue("battleXP");
        if (isWin) {
            const goldReward = Math.round((gameState.stage * 10 + Math.floor(Math.random() * 20)) * rewardsBoost * (1 + goldBoost));
            const manaReward = Math.round((gameState.stage * 5 + Math.floor(Math.random() * 10)) * rewardsBoost * (1 + manaBoost));
            gameState.lastRewards = { gold: goldReward, mana: manaReward, xp: Math.round(10 * xpBoost) };
            battleLogOverlay(`You won the battle!`);
            collectRewardsBtn.textContent = `Collect Rewards (+${goldReward} Gold, +${manaReward} Mana)`;
            collectRewardsBtn.style.display = 'block';
        } else {
            const consolationGold = Math.round(gameState.stage * 2 * rewardsBoost * (1 + goldBoost));
            gameState.lastRewards = { gold: consolationGold, mana: 0, xp: Math.round(5 * xpBoost) };
            battleLogOverlay(`You lost the battle.`);
            collectRewardsBtn.textContent = `Collect Consolation Gold (+${consolationGold} Gold)`;
            collectRewardsBtn.style.display = 'block';
        }
        const xpGain = gameState.lastRewards.xp;
        playerDeck.forEach(card => addXP(findCardById(card.id), xpGain));
        gameState.lastBattleTime = Date.now();
        updateUI();
    }

    function collectRewards() {
        if (gameState.lastRewards) {
            addGold(gameState.lastRewards.gold);
            addMana(gameState.lastRewards.mana);
            if (gameState.lastRewards.mana > 0) { gameState.stage++; log(`You won! Gained ${gameState.lastRewards.gold} Gold and ${gameState.lastRewards.mana} Mana. You are now at Stage ${gameState.stage}.`); }
            else { log(`You lost the battle. Gained ${gameState.lastRewards.gold} Gold.`); }
            gameState.lastRewards = null;
        }
    }

    // --- Events to ensure overlay closure ---
    battleCloseBtn.addEventListener('click', closeBattleOverlay);
    collectRewardsBtn.addEventListener('click', () => { collectRewards(); closeBattleOverlay(); });
    battleOverlay.addEventListener('click', (e) => { if (e.target === battleOverlay) closeBattleOverlay(); });

    // Sorting controls
    sortBtns.forEach(btn => btn.addEventListener('click', () => { gameState.sortType = btn.dataset.sort; updateUI(); }));

    // INIT
    function updateGoldDisplay() {
        goldEl.textContent = gameState.gold.toFixed(1);
        goldGainEl.textContent = gameState.goldPerSecond.toFixed(1);
        manaEl.textContent = gameState.mana.toFixed(1);
        manaGainEl.textContent = gameState.manaPerSecond.toFixed(1);
        stageEl.textContent = gameState.stage;
    }
    updateGoldDisplay();
    updateUI();
    </script>
</body>
</html>
